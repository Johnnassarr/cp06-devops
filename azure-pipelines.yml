trigger:
  - main

pool:
  name: 'self-hosted-pooll'  # Usando self-hosted agent

variables:
  # Vari√°veis do ACR e Docker
  dockerRegistryServiceConnection: '2tds251cp6rm556221'
  imageRepository: 'transaction'
  containerRegistry: '2tds251cp6rm556221.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  
  # Vari√°veis do Azure WebApp
  azureSubscription: 'AzureServiceConnection'
  webAppName: '2tds251cp6rm556221'
  resourceGroupName: 'rg-cp6-2tds'

stages:
  # ========================================
  # STAGE 1: BUILD E TESTES COM GRADLE
  # ========================================
  - stage: BuildAndTest
    displayName: 'Build and Test Application'
    jobs:
      - job: BuildJob
        displayName: 'Build and Run Tests'
        steps:
          # Instalar Java 21
          - script: |
              sudo apt-get update -qq
              sudo apt-get install -y openjdk-21-jdk
              java -version
            displayName: 'Install Java 21'
          
          # Build e Test com Gradle (usando Gradle Wrapper)
          - script: |
              chmod +x gradlew
              ./gradlew clean build test --no-daemon
            displayName: 'Gradle Build and Test'

          # Publicar resultados dos testes
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/TEST-*.xml'
              failTaskOnFailedTests: true

  # ========================================
  # STAGE 2: BUILD E PUSH DA IMAGEM DOCKER
  # ========================================
  - stage: DockerBuildPush
    displayName: 'Docker Build and Push to ACR'
    dependsOn: BuildAndTest
    condition: succeeded()
    jobs:
      - job: DockerJob
        displayName: 'Build and Push Docker Image'
        steps:
          # Build e Push da imagem Docker para o ACR
          - task: Docker@2
            displayName: 'Build and Push Docker Image'
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest

          # Exibir informa√ß√µes da imagem
          - script: |
              echo "Docker image built and pushed successfully!"
              echo "Image: $(containerRegistry)/$(imageRepository):$(tag)"
              echo "Image: $(containerRegistry)/$(imageRepository):latest"
            displayName: 'Display Image Info'

  # ========================================
  # STAGE 3: DEPLOY PARA AZURE WEBAPP
  # ========================================
  - stage: DeployToWebApp
    displayName: 'Deploy to Azure WebApp'
    dependsOn: DockerBuildPush
    condition: succeeded()
    jobs:
      - job: DeployJob
        displayName: 'Deploy Docker Container to WebApp'
        steps:
          # Login no Azure
          - task: AzureCLI@2
            displayName: 'Configure WebApp with Docker Container'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üîß Obtendo credenciais do ACR..."
                ACR_USERNAME=$(az acr credential show --name $(echo $(containerRegistry) | cut -d'.' -f1) --query "username" -o tsv)
                ACR_PASSWORD=$(az acr credential show --name $(echo $(containerRegistry) | cut -d'.' -f1) --query "passwords[0].value" -o tsv)
                
                echo "üê≥ Configurando container Docker no WebApp..."
                az webapp config container set \
                  --name $(webAppName) \
                  --resource-group $(resourceGroupName) \
                  --container-image-name $(containerRegistry)/$(imageRepository):$(tag) \
                  --container-registry-url https://$(containerRegistry) \
                  --container-registry-user $ACR_USERNAME \
                  --container-registry-password $ACR_PASSWORD
                
                echo "‚öôÔ∏è Configurando porta da aplica√ß√£o..."
                az webapp config appsettings set \
                  --name $(webAppName) \
                  --resource-group $(resourceGroupName) \
                  --settings WEBSITES_PORT=8080
                
                echo "üîÑ Reiniciando WebApp..."
                az webapp restart \
                  --name $(webAppName) \
                  --resource-group $(resourceGroupName)
                
                echo "‚úÖ Deploy conclu√≠do!"
                echo "================================================"
                echo "üåê URL da aplica√ß√£o: https://$(webAppName).azurewebsites.net"
                echo "üì¶ Imagem Docker: $(containerRegistry)/$(imageRepository):$(tag)"
                echo "================================================"
                
                echo "‚è≥ Aguardando aplica√ß√£o iniciar (30 segundos)..."
                sleep 30
                
                echo "üß™ Testando endpoint de health..."
                curl -f https://$(webAppName).azurewebsites.net/actuator/health || echo "‚ö†Ô∏è Aplica√ß√£o ainda est√° iniciando..."

